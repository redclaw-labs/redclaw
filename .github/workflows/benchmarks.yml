name: Performance Benchmarks

on:
    push:
        branches: [main]
    workflow_dispatch:

concurrency:
    group: "bench-${{ github.ref }}"
    cancel-in-progress: true

permissions:
    contents: read

env:
    CARGO_TERM_COLOR: always

jobs:
    benchmarks:
        name: Criterion Benchmarks
        runs-on: ubuntu-24.04
        timeout-minutes: 30
        steps:
            - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4
            - uses: dtolnay/rust-toolchain@631a55b12751854ce901bb631d5902ceb48146f7 # stable
              with:
                  toolchain: 1.92.0
            - uses: Swatinem/rust-cache@779680da715d629ac1d338a641029a2f4372abb5 # v3

            - name: Run benchmarks
              run: cargo bench --locked 2>&1 | tee benchmark_output.txt

            - name: Upload benchmark results
              if: always()
              uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f # v6
              with:
                  name: benchmark-results
                  path: |
                      target/criterion/
                      benchmark_output.txt
                  retention-days: 30
